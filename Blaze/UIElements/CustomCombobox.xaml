<ComboBox x:Class="Blaze.UIElements.CustomCombobox"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Blaze.UIElements"
             mc:Ignorable="d" 
             xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
             d:DesignHeight="450" d:DesignWidth="800"
             d:Background="{DynamicResource ApplicationBackgroundBrush}"
             d:Foreground="{DynamicResource OnApplicationSecondaryBrush}"
             d:Text="Testing"
          d:IsDropDownOpen="False"
             xmlns:theme="clr-namespace:Microsoft.Windows.Themes;assembly=PresentationFramework.Aero2">
    <ComboBox.Style>
        <Style TargetType="ComboBox">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <local:CustomToggleButton
                                x:Name="MoreButton"
                                IsChecked="{Binding RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay, Path=IsDropDownOpen}"
                                Background="{TemplateBinding Background}"
                                Foreground="{TemplateBinding Foreground}"
                                CornerRadius="{Binding ButtonCornerRadius, 
                                              RelativeSource={RelativeSource AncestorType=local:CustomCombobox}}"
                                Padding="{TemplateBinding Padding}"
                                Margin="{TemplateBinding Margin}"
                                HorizontalContentAlignment="Stretch"
                                VerticalAlignment="Center"
                                BorderThickness="0"
                                Visibility="{TemplateBinding Visibility}"
                                HoverColor="{TemplateBinding Background}">
                                <DockPanel IsHitTestVisible="False">
                                    <TextBox  Text="{TemplateBinding Text}"
                                                HorizontalAlignment="Left"
                                                IsHitTestVisible="False"
                                              Style="{DynamicResource Body}"
                                                Foreground="{Binding CurrentForegroundColor, 
                                                             RelativeSource={RelativeSource AncestorType=local:CustomCombobox}}"
                                                FontFamily="{TemplateBinding FontFamily}" 
                                                FontSize="{TemplateBinding FontSize}" />
                                    <local:ChangingIcon FirstKind="ChevronDown"
                                                        SecondKind="ChevronUp"
                                                        HorizontalAlignment="Right"
                                                        IsHitTestVisible="False"
                                                        Change="{TemplateBinding IsDropDownOpen}"
                                                        Foreground="{TemplateBinding Foreground}"
                                                        ActiveForeground="{Binding ToggleColor, 
                                                                           RelativeSource={RelativeSource AncestorType=local:CustomCombobox}}"
                                                        Width="10" />
                                </DockPanel>
                            </local:CustomToggleButton>
                            <Popup x:Name="PopupMenu" IsOpen="{TemplateBinding IsDropDownOpen}"
                                                            StaysOpen="False"
                                                            AllowsTransparency="True"
                                                            PlacementTarget = "{Binding ElementName = MoreButton}">
                                <local:MenuContent CornerRadius="10"
                                                   ItemsSource="{Binding Items, 
                                                                 RelativeSource={RelativeSource AncestorType=local:CustomCombobox}}"
                                                    ItemMargin="10"
                                                    Background="{Binding MenuBackgroundColor, 
                                                                 RelativeSource={RelativeSource AncestorType=local:CustomCombobox}}"
                                                    HoverColor="{Binding MenuHoverColor, 
                                                                 RelativeSource={RelativeSource AncestorType=local:CustomCombobox}}">
                                </local:MenuContent>
                            </Popup>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </ComboBox.Style>
</ComboBox>
